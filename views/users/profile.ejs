<%- layout("/layout/boilerplate") %>

  <link rel="stylesheet" href="/css/profile.css">

  <div class="profile-wrapper" id="profileWrapper">
    <!-- LEFT SIDEBAR (sticky) -->
    <div class="profile-sidebar">
      <h2>Profile</h2>
      <ul>
        <li class="active" data-tab="about">
          <div class="circle">
            <%= (currUser?.name || currUser?.username || "U" )[0].toUpperCase() %>
          </div>
          About me
        </li>
        <li data-tab="past-trips">
          <i class="fa-solid fa-suitcase"></i>
          Past trips
        </li>
        <li data-tab="connections">
          <i class="fa-solid fa-user-group"></i>
          Connections
        </li>
        <li>
          <a href="/connections/requests"
            style="display: flex; align-items: center; gap: 12px; padding: 14px; color: inherit; text-decoration: none;">
            <i class="fa-solid fa-user-plus"></i>
            Friend Requests
          </a>
        </li>
      </ul>
    </div>

    <!-- MAIN CONTENT (scrollable) -->
    <div class="profile-content">
      <!-- ABOUT ME TAB CONTENT -->
      <div id="about-content" class="tab-content active">
        <div class="profile-header">
          <h1>About me</h1>
          <button type="button" class="edit-btn" onclick="window.location='/profile/edit'">
            Edit
          </button>
        </div>

        <!-- Profile Card with Avatar -->
        <div class="profile-card">
          <div class="avatar-large">
            <% if (currUser?.profile?.avatar?.url) { %>
              <img src="<%= currUser.profile.avatar.url %>" alt="avatar" class="avatar-img">
              <% } else { %>
                <%= (currUser?.name || currUser?.username || "U" )[0].toUpperCase() %>
                  <% } %>
          </div>
          <h2>
            <%= currUser?.name || currUser?.username %>
          </h2>
          <p class="role-text">
            <%= (currUser?.host ? "Host" : "Guest" ) %>
          </p>
        </div>

        <!-- Profile Details Section (unchanged) -->
        <div class="profile-details">
          <div class="details-grid">
            <!-- All possible fields – only shown if they have a value -->
            <% if (currUser?.profile?.wanted_to_go) { %>
              <div class="detail-item">
                <span class="detail-label">Where I’ve always wanted to go</span>
                <span class="detail-value">
                  <%= currUser.profile.wanted_to_go || 'not set' %>
                </span>
              </div>
              <% } %>

                <% if (currUser?.profile?.work) { %>
                  <div class="detail-item">
                    <span class="detail-label">My work</span>
                    <span class="detail-value">
                      <%= currUser.profile.work %>
                    </span>
                  </div>
                  <% } %>

                    <% if (currUser?.profile?.fun_fact) { %>
                      <div class="detail-item">
                        <span class="detail-label">Fun fact</span>
                        <span class="detail-value">
                          <%= currUser.profile.fun_fact %>
                        </span>
                      </div>
                      <% } %>

                        <% if (currUser?.profile?.pets) { %>
                          <div class="detail-item">
                            <span class="detail-label">Pets</span>
                            <span class="detail-value">
                              <%= currUser.profile.pets %>
                            </span>
                          </div>
                          <% } %>

                            <% if (currUser?.profile?.decade_born) { %>
                              <div class="detail-item">
                                <span class="detail-label">Decade I was born</span>
                                <span class="detail-value">
                                  <%= currUser.profile.decade_born %>
                                </span>
                              </div>
                              <% } %>

                                <% if (currUser?.profile?.school) { %>
                                  <div class="detail-item">
                                    <span class="detail-label">Where I went to school</span>
                                    <span class="detail-value">
                                      <%= currUser.profile.school %>
                                    </span>
                                  </div>
                                  <% } %>

                                    <% if (currUser?.profile?.favourite_song) { %>
                                      <div class="detail-item">
                                        <span class="detail-label">My favourite song in secondary school</span>
                                        <span class="detail-value">
                                          <%= currUser.profile.favourite_song %>
                                        </span>
                                      </div>
                                      <% } %>

                                        <% if (currUser?.profile?.spend_time) { %>
                                          <div class="detail-item">
                                            <span class="detail-label">I spend too much time</span>
                                            <span class="detail-value">
                                              <%= currUser.profile.spend_time %>
                                            </span>
                                          </div>
                                          <% } %>

                                            <% if (currUser?.profile?.useless_skill) { %>
                                              <div class="detail-item">
                                                <span class="detail-label">My most useless skill</span>
                                                <span class="detail-value">
                                                  <%= currUser.profile.useless_skill %>
                                                </span>
                                              </div>
                                              <% } %>

                                                <% if (currUser?.profile?.languages) { %>
                                                  <div class="detail-item">
                                                    <span class="detail-label">Languages I speak</span>
                                                    <span class="detail-value">
                                                      <%= currUser.profile.languages %>
                                                    </span>
                                                  </div>
                                                  <% } %>

                                                    <% if (currUser?.profile?.obsessed) { %>
                                                      <div class="detail-item">
                                                        <span class="detail-label">I’m obsessed with</span>
                                                        <span class="detail-value">
                                                          <%= currUser.profile.obsessed %>
                                                        </span>
                                                      </div>
                                                      <% } %>

                                                        <% if (currUser?.profile?.bio_title) { %>
                                                          <div class="detail-item">
                                                            <span class="detail-label">My biography title would
                                                              be</span>
                                                            <span class="detail-value">
                                                              <%= currUser.profile.bio_title %>
                                                            </span>
                                                          </div>
                                                          <% } %>

                                                            <% if (currUser?.profile?.location) { %>
                                                              <div class="detail-item">
                                                                <span class="detail-label">Where I live</span>
                                                                <span class="detail-value">
                                                                  <%= currUser.profile.location %>
                                                                </span>
                                                              </div>
                                                              <% } %>

                                                                <% if (currUser?.profile?.about) { %>
                                                                  <div class="detail-item full-width">
                                                                    <span class="detail-label">About me</span>
                                                                    <span class="detail-value">
                                                                      <%= currUser.profile.about %>
                                                                    </span>
                                                                  </div>
                                                                  <% } %>

                                                                    <!-- Travel Stamps (if any) -->
                                                                    <% if (currUser?.profile?.stamps?.length) { %>
                                                                      <div class="stamps-section"
                                                                        style="grid-column: span 2; margin-top: 20px;">
                                                                        <h3>Where I’ve been</h3>
                                                                        <div class="stamps-grid">
                                                                          <% currUser.profile.stamps.forEach(stamp=> {
                                                                            %>
                                                                            <div class="stamp-item">
                                                                              <%= stamp.destination %>
                                                                            </div>
                                                                            <% }) %>
                                                                        </div>
                                                                      </div>
                                                                      <% } %>

                                                                        <!-- Interests (predefined + custom) -->
                                                                        <% const
                                                                          allInterests=(currUser?.profile?.interests ||
                                                                          []).concat(currUser?.profile?.custom_interests
                                                                          || []); %>
                                                                          <% if (allInterests.length) { %>
                                                                            <div class="interests-section"
                                                                              style="grid-column: span 2; margin-top: 20px;">
                                                                              <h3>My interests</h3>
                                                                              <div class="interests-tags">
                                                                                <% allInterests.forEach(interest=> { %>
                                                                                  <span class="interest-tag">
                                                                                    <%= interest %>
                                                                                  </span>
                                                                                  <% }) %>
                                                                              </div>
                                                                            </div>
                                                                            <% } %>

                                                                              <!-- Reviews section -->
                                                                              <div class="review-section"
                                                                                style="grid-column: span 2; margin-top: 20px;">
                                                                                <i class="fa-regular fa-comment"></i>
                                                                                Reviews I’ve written
                                                                              </div>
          </div>
        </div>
      </div> <!-- end about-content -->

      <!-- PAST TRIPS TAB CONTENT -->
      <div id="past-trips-content" class="tab-content">
        <div class="profile-header">
          <h1>Past trips</h1>
        </div>
        <% if (pastTrips && pastTrips.length> 0) { %>
          <div class="trips-grid">
            <% pastTrips.forEach(trip=> { %>
              <div class="trip-card">
                <img src="<%= trip.listing.image.url || '/default-listing.jpg' %>" alt="<%= trip.listing.title %>"
                  class="trip-image">
                <div class="trip-info">
                  <div class="trip-title">
                    <%= trip.listing.title %>
                  </div>
                  <div class="trip-location">
                    <%= trip.listing.location %>, <%= trip.listing.country %>
                  </div>
                  <div class="trip-dates">
                    <%= new Date(trip.checkIn).toLocaleDateString() %> – <%= new
                        Date(trip.checkOut).toLocaleDateString() %>
                  </div>
                  <div class="trip-actions">
                    <!-- Review button: if already reviewed, disable or show "Edit review" -->
                    <% if (!trip.reviewed) { %>
                      <a href="/reviews/new/<%= trip._id %>" class="review-btn">Write a review</a>
                      <% } else { %>
                        <span class="reviewed-badge">✓ Reviewed</span>
                        <% } %>
                          <!-- Re-book button: pre-fill booking form with same listing and dates? -->
                          <a href="/listings/<%= trip.listing._id %>?checkIn=<%= trip.checkIn.toISOString().split('T')[0] %>&checkOut=<%= trip.checkOut.toISOString().split('T')[0] %>&rooms=<%= trip.roomsBooked %>"
                            class="rebook-btn">Re-book</a>
                  </div>
                </div>
              </div>
              <% }) %>
          </div>
          <% } else { %>
            <div class="empty-state">
              <p>You’ll find your past reservations here after you’ve taken your first trip on NightNest.</p>
              <a href="/listings" class="book-btn">Book a trip</a>
            </div>
            <% } %>
      </div>

      <!-- CONNECTIONS TAB CONTENT -->
      <div id="connections-content" class="tab-content">
        <div class="profile-header">
          <h1>Connections</h1>
        </div>
        <% if (connections && connections.length> 0) { %>
          <div class="connections-grid">
            <% connections.forEach(conn=> { %>
              <div class="connection-card-wrapper">
                <!-- Link to user's public profile (entire card clickable) -->
                <a href="/users/<%= conn._id %>" class="connection-card-link">
                  <div class="connection-card">
                    <div class="connection-avatar">
                      <% if (conn.profile?.avatar?.url) { %>
                        <img src="<%= conn.profile.avatar.url %>" alt="<%= conn.name || conn.username %>">
                        <% } else { %>
                          <%= (conn.name || conn.username || "U" )[0].toUpperCase() %>
                            <% } %>
                    </div>
                    <div class="connection-info">
                      <h4>
                        <%= conn.name || conn.username %>
                      </h4>
                      <p>
                        <%= conn.profile?.location || 'Location not set' %>
                      </p>
                      <span class="connection-status-badge accepted">
                        <i class="fa-solid fa-check-circle"></i> Connected
                      </span>
                    </div>
                    
                  </div>
                </a>
                <!-- Message button (separate, inline) -->
                <a href="/messages/with/<%= conn._id %>" class="message-icon" title="Send message">
                  <i class="fa-regular fa-envelope"></i>
                </a>
              </div>
              <% }) %>
          </div>
          <% } else { %>
            <div class="empty-state">
              <p>When you join an experience or invite someone on a trip, you’ll find the profiles of other guests here.
                <a href="#" class="learn-more">Learn more</a>
              </p>
              <a href="/listings" class="book-btn">Book a trip</a>
            </div>
            <% } %>
      </div>
    </div>

    <!-- RIGHT COLUMN (only if profile incomplete) -->
    <% if (!currUser?.profile || !currUser.profile.profileCompleted) { %>
      <div class="profile-right">
        <div class="complete-profile-card">
          <h3>Complete your profile</h3>
          <p>Your NightNest profile is important.</p>
          <a href="/profile/edit" class="primary-btn">Get Started</a>
        </div>
      </div>
      <% } %>
  </div>

 <!-- Tab switching script - Enhanced -->
<script>
  (function() {
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      
      // Adjust wrapper class if right column is missing
      const wrapper = document.getElementById('profileWrapper');
      const rightColumn = document.querySelector('.profile-right');
      if (!rightColumn) wrapper.classList.add('no-right-column');

      // Get all tabs and content sections
      const tabs = document.querySelectorAll('.profile-sidebar li[data-tab]');
      const contents = {
        about: document.getElementById('about-content'),
        'past-trips': document.getElementById('past-trips-content'),
        connections: document.getElementById('connections-content')
      };

      // Function to switch tabs
      function switchTab(tabId) {
        // Remove active class from all tabs
        tabs.forEach(t => t.classList.remove('active'));
        
        // Hide all content sections
        Object.values(contents).forEach(section => {
          if (section) {
            section.classList.remove('active');
            section.style.display = 'none';
          }
        });

        // Add active class to selected tab
        const selectedTab = document.querySelector(`.profile-sidebar li[data-tab="${tabId}"]`);
        if (selectedTab) selectedTab.classList.add('active');

        // Show selected content
        if (contents[tabId]) {
          contents[tabId].classList.add('active');
          contents[tabId].style.display = 'block';
        }

        // Reset scroll position when switching tabs
        const profileContent = document.querySelector('.profile-content');
        if (profileContent) {
          profileContent.scrollTop = 0;
        }
      }

      // Add click event listeners to tabs
      tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const tabName = this.dataset.tab;
          if (tabName) {
            switchTab(tabName);
            
            // Update URL hash without page reload
            history.pushState(null, null, `#${tabName}`);
          }
        });
      });

      // Check URL hash on page load
      if (window.location.hash) {
        const hash = window.location.hash.substring(1); // Remove the #
        if (contents[hash]) {
          switchTab(hash);
        }
      }

      // Handle browser back/forward buttons
      window.addEventListener('popstate', function() {
        if (window.location.hash) {
          const hash = window.location.hash.substring(1);
          if (contents[hash]) {
            switchTab(hash);
          }
        } else {
          // Default to about tab if no hash
          switchTab('about');
        }
      });

      // Ensure only active tab content is visible on initial load
      // This fixes the issue where all tabs content shows at once
      Object.values(contents).forEach(section => {
        if (section && !section.classList.contains('active')) {
          section.style.display = 'none';
        } else if (section && section.classList.contains('active')) {
          section.style.display = 'block';
        }
      });

      // Add touch support for mobile
      if ('ontouchstart' in window) {
        tabs.forEach(tab => {
          tab.addEventListener('touchstart', function(e) {
            // Just trigger the click event
          }, { passive: true });
        });
      }
    });
  })();
</script>