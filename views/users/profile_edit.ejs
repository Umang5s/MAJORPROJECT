<%- layout("/layout/boilerplate") %>

    <link rel="stylesheet" href="/css/profile_edit.css">

    <div class="edit-profile-wrapper">
        <form action="/profile/edit" method="POST" class="edit-right" enctype="multipart/form-data" id="profileForm">

            <!-- LEFT AVATAR (sticky) -->
            <div class="edit-left">
                <div class="avatar-xl">
                    <% if (profile && profile.avatar && profile.avatar.url) { %>
                        <img src="<%= profile.avatar.url %>" class="avatar-img">
                        <% } else { %>
                            <%= (currUser && currUser.name ? currUser.name[0].toUpperCase() : 'U' ) %>
                                <% } %>
                </div>
                <input type="file" name="avatar" id="avatarInput" hidden>
                <button type="button" onclick="document.getElementById('avatarInput').click()" class="avatar-add-btn">
                    Change photo
                </button>
                <% if (profile && profile.avatar && profile.avatar.url) { %>
                    <button type="button" class="delete-photo-btn" onclick="deletePhoto()">Remove</button>
                    <% } %>
            </div>

            <!-- RIGHT CONTENT -->
            <h1 class="page-title">My profile</h1>
            <p class="subtitle">
                Hosts and guests can see your profile and it may appear across NightNest.
            </p>

            <!-- PROGRESS BAR -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 25%;"></div>
                </div>
                <div class="step-indicators">
                    <span class="step-indicator active" data-step="1">1</span>
                    <span class="step-indicator" data-step="2">2</span>
                    <span class="step-indicator" data-step="3">3</span>
                    <span class="step-indicator" data-step="4">4</span>
                </div>
            </div>

            <!-- STEP 1: PAIRED FIELDS -->
            <div class="step-content active" data-step="1">
                <div class="section">
                    <div class="form-row-grid">
                        <div class="form-item">
                            <label>Where I’ve always wanted to go</label>
                            <input type="text" name="wanted_to_go" placeholder="Where have you always wanted to travel?"
                                value="<%= profile && profile.wanted_to_go ? profile.wanted_to_go : '' %>">
                        </div>
                        <div class="form-item">
                            <label>My work</label>
                            <input type="text" name="work" placeholder="What do you do for work?"
                                value="<%= profile && profile.work ? profile.work : '' %>">
                        </div>
                    </div>
                    <div class="form-row-grid">
                        <div class="form-item">
                            <label>My fun fact</label>
                            <input type="text" name="fun_fact" placeholder="What’s a fun fact about you?"
                                value="<%= profile && profile.fun_fact ? profile.fun_fact : '' %>">
                        </div>
                        <div class="form-item">
                            <label>Pets</label>
                            <input type="text" name="pets" placeholder="Do you have any pets in your life?"
                                value="<%= profile && profile.pets ? profile.pets : '' %>">
                        </div>
                    </div>
                    <div class="form-row-grid">
                        <div class="form-item">
                            <label>Decade I was born</label>
                            <input type="text" name="decade_born" placeholder="Decade you were born"
                                value="<%= profile && profile.decade_born ? profile.decade_born : '' %>">
                        </div>
                        <div class="form-item">
                            <label>Where I went to school</label>
                            <input type="text" name="school" placeholder="Where did you go to school?"
                                value="<%= profile && profile.school ? profile.school : '' %>">
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 2: SINGLE COLUMN FIELDS -->
            <div class="step-content" data-step="2">
                <div class="section">
                    <div class="form-row">
                        <label>My favourite song in secondary school</label>
                        <input type="text" name="favourite_song"
                            placeholder="What was your favourite song in secondary school?"
                            value="<%= profile && profile.favourite_song ? profile.favourite_song : '' %>">
                    </div>
                    <div class="form-row">
                        <label>I spend too much time</label>
                        <input type="text" name="spend_time" placeholder="What do you spend too much time doing?"
                            value="<%= profile && profile.spend_time ? profile.spend_time : '' %>">
                    </div>
                    <div class="form-row">
                        <label>My most useless skill</label>
                        <input type="text" name="useless_skill" placeholder="What’s your most useless skill?"
                            value="<%= profile && profile.useless_skill ? profile.useless_skill : '' %>">
                    </div>
                    <div class="form-row">
                        <label>Languages I speak</label>
                        <input type="text" name="languages" placeholder="Languages you speak"
                            value="<%= profile && profile.languages ? profile.languages : '' %>">
                    </div>
                    <div class="form-row">
                        <label>I’m obsessed with</label>
                        <input type="text" name="obsessed" placeholder="What are you obsessed with?"
                            value="<%= profile && profile.obsessed ? profile.obsessed : '' %>">
                    </div>
                    <div class="form-row">
                        <label>My biography title would be</label>
                        <input type="text" name="bio_title" placeholder="What would your biography title be?"
                            value="<%= profile && profile.bio_title ? profile.bio_title : '' %>">
                    </div>
                    <div class="form-row">
                        <label>Where I live</label>
                        <input type="text" name="location" placeholder="Where you live"
                            value="<%= profile && profile.location ? profile.location : '' %>">
                    </div>
                </div>
            </div>

            <!-- STEP 3: ABOUT ME + TRAVEL STAMPS -->
            <div class="step-content" data-step="3">
                <div class="section">
                    <h2>About me</h2>
                    <textarea name="about"
                        placeholder="Write something fun and punchy..."><%= profile && profile.about ? profile.about : '' %></textarea>
                    <button type="button" class="add-intro-btn">Add intro</button>
                </div>
                <div class="section">
                    <h2>Where I’ve been</h2>
                    <p class="section-subtitle">Pick the stamps you want other people to see on your profile.</p>
                    <div class="stamps-grid">
                        <% const stamps=(profile && profile.stamps) ? profile.stamps : []; %>
                            <% for (let i=0; i < 4; i++) { const stamp=stamps[i] || { destination: 'Next destination' };
                                %>
                                <div class="stamp-item">
                                    <div class="stamp-placeholder">
                                        <%= stamp.destination %>
                                    </div>
                                    <input type="hidden" name="stamps[<%= i %>][destination]"
                                        value="<%= stamp.destination %>">
                                </div>
                                <% } %>
                    </div>
                    <div class="stamps-footer">
                        <span class="stamps-count">
                            <%= stamps.length %> of 4 items showing
                        </span>
                        <a href="#" class="edit-stamps-link">Edit travel stamps</a>
                    </div>
                </div>
            </div>

            <!-- STEP 4: INTERESTS + FINAL (UPDATED) -->
            <div class="step-content" data-step="4">
                <div class="section">
                    <h2>My interests</h2>
                    <p class="section-subtitle">Find common ground with other guests and hosts by adding interests to
                        your profile.</p>


                    <div class="selected-interests-container" id="selectedInterestsContainer"></div>


                    <div id="hiddenInterestsContainer">
                        <% if (profile?.interests) { %>
                            <% profile.interests.forEach(interest=> { %>
                                <input type="hidden" name="interests[]" value="<%= interest %>">
                                <% }); %>
                                    <% } %>
                    </div>


                    <div class="custom-tag-container" id="customInterestsContainer">
                        <% (profile?.custom_interests || []).forEach(interest=> { %>
                            <div class="custom-tag">
                                <span>
                                    <%= interest %>
                                </span>
                                <button type="button" class="remove-tag" aria-label="Remove">×</button>
                                <input type="hidden" name="custom_interests[]" value="<%= interest %>">
                            </div>
                            <% }) %>
                    </div>


                    <button type="button" class="add-interests-btn" id="openInterestModalBtn">Pick interests</button>
                    <button type="button" class="add-interests-btn" id="openCustomModalBtn" style="margin-left: 8px;">+
                        Add custom</button>
                </div>
            </div>


            <div id="interestPickerModal" class="modal">
                <div class="modal-content modal-lg">
                    <span class="close-modal" id="closePickerModal">&times;</span>
                    <h2>What are you into?</h2>
                    <p class="section-subtitle">Pick some interests that you enjoy and that you want to show on your
                        profile.</p>
                    <div class="interests-grid" id="interestsGrid"></div>
                    <div style="text-align: right; margin: 12px 0;">
                        <a href="#" class="show-all-link">Show all</a>
                    </div>
                    <div class="selection-counter" id="selectionCounter">0/<%= allInterests.length %> selected</div>
                    <div class="modal-actions">
                        <button type="button" class="modal-cancel" id="cancelPicker">Cancel</button>
                        <button type="button" class="modal-save" id="savePicker">Save</button>
                    </div>
                </div>
            </div>
            <!-- Custom Interest Modal (Airbnb style) -->
            <div id="customInterestModal" class="modal">
                <div class="modal-content" style="max-width: 400px;">
                    <span class="close-modal" id="closeCustomModal">&times;</span>
                    <h3 style="margin-bottom: 16px;">Add a custom interest</h3>
                    <input type="text" id="customInterestInput" placeholder="e.g., Hiking, Painting, Yoga"
                        maxlength="50"
                        style="width: 100%; padding: 12px; border: 1px solid #b0b0b0; border-radius: 8px; font-size: 16px; margin-bottom: 24px;">
                    <div class="modal-actions">
                        <button type="button" class="modal-cancel" id="cancelCustom">Cancel</button>
                        <button type="button" class="modal-save" id="addCustomBtn">Add</button>
                    </div>
                </div>
            </div>

            <div class="step-navigation">
                <button type="button" class="nav-btn prev-btn" id="prevBtn" disabled>Previous</button>
                <button type="button" class="nav-btn next-btn" id="nextBtn">Next</button>
                <button type="submit" class="done-btn" id="doneBtn" style="display: none;">Done</button>
            </div>
            <div id="successMessage" class="success-message" style="display: none;">Interests saved!</div>
        </form>
    </div>

    <script>
        window.allInterests = <% - JSON.stringify(allInterests) %>;
    </script>

    <script src="/js/profile_edit.js"></script>