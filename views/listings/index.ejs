<% layout("/layout/boilerplate") %>

    <style>
        /* Existing styles... */
        .filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 2rem;
            position: relative;
            max-width: 100%;
            overflow: hidden;
        }

        .filter-scroll {
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            padding: 10px 0;
            scrollbar-width: none;
        }

        .filter-scroll::-webkit-scrollbar {
            display: none;
        }

        #filters {
            display: flex;
            gap: 15px;
            width: max-content;
            padding: 0 10px;
        }

        .filter {
            text-align: center;
            opacity: 0.7;
            text-decoration: none;
            color: inherit;
            min-width: 80px;
            flex-shrink: 0;
        }

        .scroll-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            z-index: 1;
        }

        .scroll-btn.hidden {
            visibility: hidden;
        }

        .tax-toogle {
            border: 1px solid #ddd;
            border-radius: 1rem;
            height: 3.5rem;
            padding: 0 1rem;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            background-color: white;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .tax-toogle:hover {
            border-color: #bbb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-check-reverse {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-direction: row-reverse;
        }

        .form-switch .form-check-input {
            width: 2.5em;
            height: 1.5em;
            margin-left: 0;
            background-color: #ddd;
            border: none;
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: #0d6efd;
        }

        .form-check-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            user-select: none;
        }

        .heart-btn {
            position: absolute;
            top: 15px;
            right: 50px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: all 0.2s ease;
        }

        .heart-btn:hover {
            transform: scale(1.1);
        }

        .heart-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .card-deck {
            position: relative;
            margin-bottom: 20px;
        }

        .hover-shadow:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }

        .card-title {
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 576px) {
            .tax-toogle {
                padding: 0 0.75rem;
                margin-left: 1rem;
            }

            .form-check-label {
                font-size: 0.85rem;
            }
        }
    </style>

    <div class="filter-container">
        <button class="scroll-btn left-btn hidden" id="scrollLeftBtn"><i class="fa-solid fa-chevron-left"></i></button>
        <div class="filter-scroll" id="filterScroll">
            <div id="filters">
                <!-- Your filters -->
                <a href="/listings?category=All" class="filter">
                    <div><i class="fa-solid fa-bars"></i></div>
                    <p>All</p>
                </a>
                <a href="/listings?category=Trending" class="filter">
                    <div><i class="fa-solid fa-fire"></i></div>
                    <p>Trending</p>
                </a>
                <a href="/listings?category=Castles" class="filter">
                    <div><i class="fa-solid fa-chess-rook"></i></div>
                    <p>Castles</p>
                </a>
                <a href="/listings?category=Mountains" class="filter">
                    <div><i class="fa-solid fa-mountain"></i></div>
                    <p>Mountains</p>
                </a>
                <a href="/listings?category=IconicCities" class="filter">
                    <div><i class="fa-solid fa-city"></i></div>
                    <p>Iconic Cities</p>
                </a>
                <a href="/listings?category=Rooms" class="filter">
                    <div><i class="fa-solid fa-bed"></i></div>
                    <p>Rooms</p>
                </a>
                <a href="/listings?category=AmazingPools" class="filter">
                    <div><i class="fa-solid fa-water-ladder"></i></div>
                    <p>Amazing Pools</p>
                </a>
                <a href="/listings?category=Camping" class="filter">
                    <div><i class="fa-solid fa-campground"></i></div>
                    <p>Camping</p>
                </a>
                <a href="/listings?category=Farms" class="filter">
                    <div><i class="fa-solid fa-tractor"></i></div>
                    <p>Farms</p>
                </a>
                <a href="/listings?category=Arctic" class="filter">
                    <div><i class="fa-solid fa-snowflake"></i></div>
                    <p>Arctic</p>
                </a>
            </div>
        </div>
        <button class="scroll-btn right-btn" id="scrollRightBtn"><i class="fa-solid fa-chevron-right"></i></button>

        <div class="tax-toogle">
            <div class="form-check-reverse form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                <label class="form-check-label" for="flexSwitchCheckDefault">Display total before taxes</label>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
            <% for (let listing of listings) { %>
                <div class="col">
                    <div class="card h-100 shadow-sm border-0 rounded-4 position-relative hover-shadow">

                        <!-- Heart (Favorite) Button -->
                        <button
                            class="btn position-absolute top-0 end-0 m-2 heart-btn border-0 bg-white bg-opacity-75 rounded-circle"
                            data-listing-id="<%= listing._id %>"
                            style="color: <%= watchlistListingIds.includes(listing._id.toString()) ? 'red' : '#999' %>; font-size: 1.4rem;">
                            <%= watchlistListingIds.includes(listing._id.toString()) ? '♥' : '♡' %>
                        </button>

                        <!-- Listing Image -->
                        <a href="/listings/<%= listing._id %>" class="text-decoration-none text-dark">
                            <img src="<%= listing.image.url %>" class="card-img-top" alt="listing image"
                                style="height: 230px; object-fit: cover;">
                        </a>

                        <!-- Card Body -->
                        <div class="card-body px-3">
                            <!-- Title -->
                            <h5 class="card-title fw-bold text-truncate">
                                <%= listing.title %>
                            </h5>

                            <!-- Category Badge -->
                            <span class="badge bg-secondary mb-2">
                                <%= listing.category %>
                            </span>

                            <!-- Review Summary -->
                            <% if (listing.reviewCount> 0 && listing.avgRating !== null) { %>
                                <div class="mb-1 text-warning">
                                    <% const rating=Math.min(5, Math.max(1, Math.round(listing.avgRating))); %>
                                        <% for (let i=1; i <=5; i++) { %>
                                            <i class="<%= i <= rating ? 'fa-solid' : 'fa-regular' %> fa-star"></i>
                                            <% } %>
                                                <span class="text-dark ms-1">
                                                    (<%= Number(listing.avgRating).toFixed(1) %>/5)
                                                </span>
                                </div>
                                <small class="text-muted">
                                    <%= listing.reviewCount %> review<%= listing.reviewCount !==1 ? 's' : '' %>
                                </small>
                                <% } else { %>
                                    <p class="text-muted">No ratings yet</p>
                                    <% } %>

                                        <!-- Price -->
                                        <p class="mt-2 fw-semibold fs-6">
                                            ₹ <%= listing.price.toLocaleString("en-IN") %>/ night
                                                <small class="text-muted tax-info" style="display: none;">+ 18%
                                                    GST</small>
                                        </p>
                        </div>
                    </div>
                </div>
                <% } %>
        </div>
    </div>


    <!-- Watchlist Modal -->
    <div class="modal fade" id="watchlistModal" tabindex="-1" aria-labelledby="watchlistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="watchlistForm">
                <div class="modal-content rounded-4">
                    <div class="modal-header">
                        <h5 class="modal-title" id="watchlistModalLabel">Add to Watchlist</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="listingId" id="modalListingId" />
                        <div class="mb-3">
                            <input type="text" class="form-control" name="newWatchlist"
                                placeholder="New Watchlist Name" />
                        </div>
                        <p>Select existing watchlist:</p>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="existingWatchlist" value="Favorites"
                                id="fav" />
                            <label class="form-check-label" for="fav">Favorites</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="existingWatchlist" value="Summer"
                                id="summer" />
                            <label class="form-check-label" for="summer">Summer</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save to Watchlist</button>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const taxSwitch = document.getElementById("flexSwitchCheckDefault");
            if (taxSwitch) {
                taxSwitch.addEventListener("change", () => {
                    const taxInfoElements = document.querySelectorAll(".tax-info");
                    taxInfoElements.forEach(info => {
                        info.style.display = taxSwitch.checked ? "inline" : "none";
                    });
                });
            }

            document.addEventListener('click', async (e) => {
                const heartBtn = e.target.closest('.heart-btn');
                if (!heartBtn) return;


                e.preventDefault();
                e.stopPropagation();

                const isLoggedIn = "<%= currUser ? 'true' : 'false' %>";

                if (isLoggedIn !== 'true') {
                    window.location.href = '/login';
                    return;
                }
                const listingId = heartBtn.dataset.listingId;
                const isFavorited = heartBtn.innerHTML.includes('♥');

                try {
                    heartBtn.disabled = true;
                    const originalHTML = heartBtn.innerHTML;
                    heartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                    if (!isFavorited) {
                        document.getElementById("modalListingId").value = listingId;
                        const modal = new bootstrap.Modal(document.getElementById("watchlistModal"));
                        modal.show();
                    } else {
                        const confirmed = confirm("Remove this listing from your watchlist?");
                        if (!confirmed) {
                            heartBtn.innerHTML = originalHTML;
                            return;
                        }

                        const response = await fetch(`/watchlist/remove/${listingId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include'
                        });

                        if (!response.ok) throw new Error('Failed to remove from watchlist');

                        heartBtn.innerHTML = '♡';
                        heartBtn.style.color = 'gray';
                    }
                } catch (err) {
                    console.error("Error:", err);
                    alert(err.message);
                    heartBtn.innerHTML = isFavorited ? '♥' : '♡';
                    heartBtn.style.color = isFavorited ? 'red' : 'gray';
                } finally {
                    heartBtn.disabled = false;
                }
            });

            const watchlistForm = document.getElementById("watchlistForm");

            if (watchlistForm) {
                watchlistForm.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const form = e.target;
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData);
                    const listingId = formData.get("listingId");

                    const submitBtn = watchlistForm.querySelector('button[type="submit"]');

                    try {
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                        const response = await fetch("/watchlist/add", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error("Server response:", errorData);
                            throw new Error(errorData.message || 'Failed to add to watchlist');
                        }

                        const heartBtn = document.querySelector(`.heart-btn[data-listing-id="${listingId}"]`);
                        if (heartBtn) {
                            heartBtn.innerHTML = '♥';
                            heartBtn.style.color = 'red';
                        }

                        const modal = bootstrap.Modal.getInstance(document.getElementById("watchlistModal"));
                        modal.hide();

                        alert('Successfully added to watchlist!');
                    } catch (err) {
                        console.error("Error adding to watchlist:", err);
                        alert(err.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save to Watchlist';
                    }
                });
            }


            const scrollContainer = document.getElementById("filterScroll");
            if (scrollContainer) {
                const leftBtn = document.getElementById("scrollLeftBtn");
                const rightBtn = document.getElementById("scrollRightBtn");
                const filtersContainer = document.getElementById("filters");
                const scrollAmount = 200;

                if (leftBtn && rightBtn) {
                    leftBtn.addEventListener("click", () => {
                        scrollContainer.scrollBy({ left: -scrollAmount, behavior: "smooth" });
                    });

                    rightBtn.addEventListener("click", () => {
                        scrollContainer.scrollBy({ left: scrollAmount, behavior: "smooth" });
                    });

                    scrollContainer.addEventListener("scroll", () => {
                        leftBtn.classList.toggle("hidden", scrollContainer.scrollLeft <= 0);
                        const maxScroll = filtersContainer.scrollWidth - scrollContainer.clientWidth;
                        rightBtn.classList.toggle("hidden", scrollContainer.scrollLeft >= maxScroll);
                    });

                    const checkScrollButtons = () => {
                        const maxScroll = filtersContainer.scrollWidth - scrollContainer.clientWidth;
                        leftBtn.classList.toggle("hidden", scrollContainer.scrollLeft <= 0);
                        rightBtn.classList.toggle("hidden", scrollContainer.scrollLeft >= maxScroll || maxScroll <= 0);
                    };
                    window.addEventListener("load", checkScrollButtons);
                    window.addEventListener("resize", checkScrollButtons);
                }
            }
        });
    </script>